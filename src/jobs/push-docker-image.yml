description: >
  Builds and pushes the docker image to ECR (using the persisted workspace. hence, it's required to run build first). Requires AWS_ECR_ACCOUNT_URL env var.

executor: aws-ecr/default

parameters:
  resource-name:
    type: env_var_name
    default: AWS_RESOURCE_NAME_PREFIX
  npm-token-env:
    type: env_var_name
    default: NPM_TOKEN

steps:
  - run: env
  - aws-ecr/build-and-push-image:
      checkout: false
      attach-workspace: true
      workspace-root: ~/project
      create-repo: true
      extra-build-args: >-
        --build-arg NPM_TOKEN=$<< parameters.npm-token-env >>
        --build-arg COMMIT_HASH=${CIRCLE_SHA1}
      account-url: AWS_ECR_ACCOUNT_URL
      repo: '$<< parameters.npm-token-env >>'
      tag: '${CIRCLE_SHA1}'